#!/usr/bin/env python

import os
import sys
import subprocess

def find_files():
    
    command = "ag --silent --files-with-matches --literal '%s'" % sys.argv[1]
    
    output = ''
    try:
        output = subprocess.check_output(command, shell = True)
    except subprocess.CalledProcessError:
        pass

    return output.split('\n')

def transform(file):

    if len(file) == 0:
        return
    
    with open(file, 'r') as f:
        contents = f.read()
    
    if contents.find(sys.argv[1]) == -1:
        return
    
    replaced = contents.replace(sys.argv[1], sys.argv[2])
    with open(file, 'w') as f:
        f.write(replaced)
    
def main():

    if len(sys.argv) != 3:
        print('Usage: replace [from] [to] < [files]')
        sys.exit(1)

    if sys.stdin.isatty():
        files = find_files()
    else:
        files = sys.stdin.read().split('\n')
    
    for file in files:
        transform(file)

if __name__ == '__main__':
    main()
